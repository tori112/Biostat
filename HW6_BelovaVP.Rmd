---
title: "HW6_BelovaVP_Тема: расчет выборки при планировании исследования."
author: "Belova"
date: "2024-04-05"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

# Необходимо посчитать выборки для различных типов точек. Напишите соответствующий код, пользуясь указанными формулами.

## Пусть наш спонсор заинтересован, чтобы исследование имело 80% мощность, а уровень значимости — 5%, ожидаемый drop-out rate = 10%.

### Задание 1.

Рассчитайте выборку для исследования терапевтической эквивалентности для двухпериодного cross-over дизайна.
Из предыдущих исследований известно, что дисперсия составляет 20% ( = 0.20), а разница средних составляет −10%.
Клиницисты сообщают нам, что клинически значимая разница составляет 25%.

**Решение:**

Нам понадобится формула:

с использованием LaTeX-нотации:

n_1=n_2=\frac{\left(Z_{\alpha / 2}+Z_\beta\right)^2 \sigma_m^2}{2 *(\delta-|\varepsilon|)^2}, n=n_1+n_2

Где:

-   ( n_1, n_2 ) - Размеры выборок для двух сравниваемых групп. По условию задачи они равны.
-   ( Z\_{\alpha / 2} ) - Квантиль нормального распределения для уровня значимости ( \alpha ), деленного на 2 (для двустороннего теста). Другими словами, это значение Z-оценки, которое соответствует вероятности ( \alpha/2 ) в правом хвосте стандартного нормального распределения.
-   ( Z\_\beta ) - Квантиль нормального распределения для мощности испытания (1 - ( \beta )),где (\beta) - вероятность ошибки второго рода (не обнаружить реальное различие, когда оно есть).
-   ( \sigma\_m\^2 ) - Оценка дисперсии измеряемого исхода.
-   ( \delta ) - Размер эффекта, то есть разница между группами, которую мы хотим обнаружить.
-   ( \varepsilon ) - Маржа ошибки, т.е. наименьшая значимая разница, которую мы хотим обнаружить.
-   ( n ) - Общий размер выборки, который является суммой размеров выборок для каждой группы.

или

n_1 = n_2 = (Z\_(α/2) + Z_β)\^2 \* σ_m\^2 / (2 \* (δ - \|ε\|)\^2) n = n_1 + n_2

где:

-   n_1, n_2 - Размеры выборок для двух сравниваемых групп. В данном контексте они равны, так как предполагается, что обе группы должны быть одинакового размера для сравнения.
-   Z\_(α/2) - Квантиль стандартного нормального распределения для уровня значимости α деленного на 2. Это значение соответствует вероятности α/2 в каждом хвосте стандартного нормального распределения для двустороннего теста.
-   Z_β - Квантиль стандартного нормального распределения для мощности исследования, равной 1 - β, где β - вероятность ошибки второго рода (не обнаружить разницу, когда она действительно существует).
-   σ_m\^2 - Оценка дисперсии в измерениях. В контексте исследования, σ_m\^2 может быть оценкой общей дисперсии или комбинированной вариативности обеих групп.
-   δ - Значение минимальной клинически значимой разницы, которую исследование предназначено обнаружить.
-   \|ε\| - Абсолютное значение погрешности измерения или другой случайной ошибки, которая может влиять на измерения. Если эта величина не учитывается, тогда формула упрощается до отсутствия \|ε\|.
-   (δ - \|ε\|)\^2 - Квадрат разности между желаемой обнаруживаемой разницей δ и погрешностью ε. Это значение представляет квадрат эффективного размера эффекта, учитывая погрешность.
-   n - Общий размер выборки для исследования, который является суммой размеров выборок для каждой группы.

```{r}
# Установка параметров для расчета размера выборки
alpha <- 0.05 # уровень значимости
power <- 0.80 # мощность исследования
dropout_rate <- 0.10 # drop-out rate
variance <- 0.20 # дисперсия (sigma^2)
mean_difference <- -0.10 # разница средних (delta)
clinically_significant_difference <- 0.25 # клинически значимая разница (epsilon)

# Расчет стандартного отклонения (sigma)
sigma <- sqrt(variance)

# Расчет Z значения для alpha и beta (мощность)
Z_alpha_2 <- qnorm(1 - alpha / 2)
Z_beta <- qnorm(power)

# Расчет размера выборки для каждой группы (n_1 и n_2)
n_1 <- (Z_alpha_2 + Z_beta)^2 * sigma^2 / (2 * (clinically_significant_difference - abs(mean_difference))^2)
n_1 <- ceiling(n_1 / (1 - dropout_rate)) # Корректировка на drop-out rate

# Общий размер выборки (поскольку дизайн кроссоверный, n_1 = n_2)
n <- n_1 * 2

# Вывод результатов
cat("Размер выборки для каждой группы (n_1 и n_2):", n_1, "\n")
cat("Общий размер выборки (n):", n, "\n")
```

### Ответ:

Общий размер выборки должен быть 78 человек.

### Задание 2.

Рассчитайте выборку для гипотезы non-inferiority для двухвыборочного параллельного дизайна.
Пусть клинически значимая разница = -0.1, то есть мы ожидаем разницу не меньше 10%, а долю ответов для тестового препарата = 0.65, в то время как нам известно из предыдущих исследований, что доля ответов у препарата сравнения составляет = 0.85.
Соотношение групп равно = 1.

**Решение:**

Для расчета выборки для гипотезы non-inferiority для двухвыборочного параллельного дизайна нам понадобится формула:

с использованием LaTeX-нотации:

n_1=n_2=\frac{\left(Z_{\alpha/2}+Z_\beta\right)^2\left(p_1^*\left(1-p_1\right)+p_2^*\left(1-p_2\right)\right)}{\left(p_1-p_2-\delta\right)^2}, n=n_1+n_2

Где:

-   ( Z\_{\alpha / 2} ) - Z-значение для уровня значимости (\alpha), используется для двустороннего теста
-   ( Z\_\beta ) - Z-значение для мощности исследования (1 - (\beta)), где (\beta) — вероятность ошибки второго рода
-   ( p_1 ) и ( p_2 )- ожидаемые доли ответов для тестового препарата и препарата сравнения соответственно
-   ( p_1\^\* ) и ( p_2\^\* ) - скорректированные доли ответов с учетом drop-out rate
-   \delta ) - клинически значимая разница
-   ( n_1 ) и ( n_2 ) размеры выборок для двух групп
-   ( n ) - общий размер выборки

или

n_1 = n_2 = ((Z\_(α/2) + Z_β)\^2 \* (p1 \* (1 - p1) + p2 \* (1 - p2))) / ((p1 - p2 - δ)\^2) n = n_1 + n_2

-   n_1, n_2 - Размеры выборок для двух сравниваемых групп, которые должны быть равны друг другу.
-   Z\_(α/2) - Квантиль стандартного нормального распределения для уровня значимости α, деленного на 2 (для двустороннего теста). Это значение Z-оценки, которое соответствует вероятности α/2 в правом хвосте стандартного нормального распределения.
-   Z_β - Квантиль стандартного нормального распределения для мощности исследования 1 - β, где β - вероятность ошибки второго рода.
-   p1, p2 - Пропорции (доли) интересующего события в первой и второй группах соответственно.
-   (p1 \* (1 - p1) + p2 \* (1 - p2)) - Сумма вариаций для двух пропорций. Это слагаемое учитывает вариативность в каждой группе.
-   δ - Значение минимальной клинически значимой разницы между пропорциями p1 и p2, которую исследование предназначено обнаружить.
-   (p1 - p2 - δ)\^2 - Квадрат разности между разностью пропорций p1 и p2 и значением δ. Это выражение представляет квадрат эффекта размера, который исследование пытается обнаружить.
-   n - Общий размер выборки, который является суммой размеров выборок обеих групп.

```{r}
# Установка параметров для расчета размера выборки
alpha <- 0.05 # уровень значимости
power <- 0.80 # мощность исследования
dropout_rate <- 0.10 # drop-out rate
p1 <- 0.65 # доля ответов для тестового препарата
p2 <- 0.85 # доля ответов у препарата сравнения
delta <- -0.1 # клинически значимая разница

# Расчет скорректированных долей ответов
p1_star <- p1 * (1 - dropout_rate)
p2_star <- p2 * (1 - dropout_rate)

# Расчет Z значения для alpha и beta (мощность)
Z_alpha_2 <- qnorm(1 - alpha / 2)
Z_beta <- qnorm(power)

# Расчет размеров выборок для каждой группы (n_1 и n_2)
n_1 <- (Z_alpha_2 + Z_beta)^2 * (p1_star * (1 - p1) + p2_star * (1 - p2)) / (p1 - p2 - delta)^2
n_1 <- ceiling(n_1) # Округление до ближайшего большего целого числа

# Общий размер выборки (поскольку соотношение групп равно 1, n_1 = n_2)
n <- n_1 * 2

# Вывод результатов
cat("Размер выборки для каждой группы (n_1 и n_2):", n_1, "\n")
cat("Общий размер выборки (n):", n, "\n")
```

### Ответ:

Общий размер выборки должен быть 502 человека.

### Задание 3.

Рассчитайте выборку для гипотезы equality для следующего исследования.
Мы хотим сравнить новую терапию инфекции, присоединяющейся в больничных условиях у пациентов с ожогами, с золотым стандартом, основываясь на данных, анализируемых с помощью регрессии Кокса.
Пусть отношение рисков «золотой стандарт / новая терапия», hazard ratio, HR = 2.
Мы предполагаем, что 80% пациентов (d = 0.8) могут столкнуться с этим заболеванием.
Соотношения групп терапии равны 0.5.

**Решение:**

Для расчета выборки для гипотезы equality в исследовании сравнения новой терапии инфекции у пациентов с ожогами с золотым стандартом, основываясь на данных, анализируемых с помощью регрессии Кокса, нам понадобится формула:

с использованием LaTeX-нотации:

n_1=n_2=\frac{\left(Z_{\alpha / 2}+Z_\beta\right)^2}{\ln(HR)^2*p_1*p_2*d}, n=n_1+n_2

где:

-   ( Z\_{\alpha / 2} ) - квантиль стандартного нормального распределения для уровня значимости (\alpha), деленного на 2 (для двустороннего теста).
-   ( Z\_\beta ) - квантиль стандартного нормального распределения для мощности исследования.
-   ( HR ) - отношение рисков (hazard ratio) между контрольной группой и группой с новой терапией.
-   ( p_1 ) и ( p_2 ) - соотношения размеров групп терапии, где ( p_1 ) относится к группе с новой терапией и ( p_2 ) к группе со стандартной терапией.
-   ( d ) - предполагаемая доля пациентов, которые могут столкнуться с исследуемым событием.
-   ( n_1 ) и ( n_2 ) - размеры выборок для каждой из групп.
-   ( n ) - общий размер выборки.

или

n_1 = n_2 = (Z\_(α/2) + Z_β)\^2 / (ln(HR)\^2 \* p1 \* p2 \* d) n = n_1 + n_2

Где:

-   n_1, n_2 - Размеры выборок для двух сравниваемых групп, которые должны быть равны друг другу.
-   Z\_(α/2) - Квантиль стандартного нормального распределения для уровня значимости α, деленного на 2 (для двустороннего теста). Это значение Z-оценки, которое соответствует вероятности α/2 в правом хвосте стандартного нормального распределения.
-   Z_β - Квантиль стандартного нормального распределения для мощности исследования 1 - β, где β - вероятность ошибки второго рода.
-   ln(HR) - Натуральный логарифм отношения рисков (Hazard Ratio, HR). Отношение рисков является мерой, используемой в клинических испытаниях для сравнения риска некоторого события между двумя группами.
-   p1, p2 - Пропорции (доли) интересующего события в первой и второй группах соответственно.
-   d - Коэффициент дизайна исследования, который учитывает определенные аспекты дизайна, например, парное сравнение или кластеризацию.
-   n - Общий размер выборки, который является суммой размеров выборок обеих групп.

```{r}
# Установка параметров для расчета размера выборки
alpha <- 0.05 # уровень значимости
power <- 0.80 # мощность исследования
HR <- 2 # отношение рисков (hazard ratio)
d <- 0.8 # предполагаемая доля пациентов, сталкивающихся с заболеванием
p1 <- 1 # поскольку соотношения групп терапии равны 0.5, p1 будет равно 1
p2 <- 0.5 / (1 - 0.5) # соотношение размеров групп

# Расчет Z-значений для alpha и power
Z_alpha_2 <- qnorm(1 - alpha / 2)
Z_beta <- qnorm(power)

# Расчет размеров выборок для каждой группы (n_1 и n_2)
n_1 <- (Z_alpha_2 + Z_beta)^2 / (log(HR)^2 * p1 * p2 * d)
n_1 <- ceiling(n_1) # Округление до ближайшего большего целого числа

# Общий размер выборки (n)
n <- n_1 * (1 + 1 / p2)

# Вывод результатов
cat("Размер выборки для новой терапии (n_1):", n_1, "\n")
cat("Размер выборки для 'золотого стандарта' (n_2):", n_1 / p2, "\n")
cat("Общий размер выборки (n):", n, "\n")

```

### Ответ:

Общий размер выборки должен быть 42 человека.
